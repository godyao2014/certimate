name: Docker Image Build (Local Export)

on:
  push:
    tags:
      - "v[0-9]*"
      - "!v*alpha*"
      - "!v*beta*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag version to be used for Docker image"
        required: true
        default: "latest"

jobs:
  build-and-export:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 保留 QEMU/Buildx 以支持多架构构建
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 简化元数据生成（仅生成本地标签）
      - name: Generate Docker tags
        id: meta
        run: |
          echo "TAG=local-$(date +%s)" >> $GITHUB_OUTPUT

      # 核心修改：构建并导出镜像文件
      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: false  # 禁止推送
          tags: localbuild/certimate:${{ steps.meta.outputs.TAG }}
          outputs: type=docker,dest=./certimate.tar  # 导出为tar文件

      # 上传构建结果
      - name: Upload Docker image
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: |
            ./certimate.tar
            ./Dockerfile  # 可选：附带Dockerfile
